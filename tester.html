<html>
    <head>
        <title> websocket test </title>
    </head>

    <body>

        <style>
            body {
                font-family: Verdana, sans-serif;
                color: white
            }
            tr {
                border: 1px solid orange;
            }
            td {
                border: 1px solid purple;
            }

            .skeleton {
                opacity: 0.6;
                animation: skeleton-loading 0.5s linear infinite alternate;
                border-radius: 8px;
            }

            @keyframes skeleton-loading {
                0% {
                /* background-color: hsl(199, 81%, 44%); */
                    filter: grayscale(0)
                }
                100% {
                /* background-color: hsl(200, 20%, 95%); */
                    filter: grayscale(70) brightness(20)
                }
            }

        </style>

        <div style="width: 25vh; padding: 0.5vh; background-color:#141314">

            <div style="text-align: center">
                N26 -> LunchMoney
            </div>

            <div style="text-align: center; padding: 1vh">
                <a href="" style="text-decoration: none; color: white" id="importTransactionsButton">
                    <div style="font-weight: bold; font-size: 1.5vh; display: inline; border: 2px solid grey; padding: 0.2vh 2vh 0.2vh 2vh; border-top-right-radius: 0.9vh; border-bottom-left-radius: 0.9vh;">
                        Import Transactions
                    </div>
                </a>    
            </div>

            <div style="padding: 1vh; padding-top: 0; padding-bottom: 0">
                <div style="text-align: center; margin-bottom: 0.0; border: 1px solid grey">
                    <table style="font-size: 1.2vh">
                        <tr>
                            <td>
                                <span style="margin-left: 0.5vh; margin-right: 0.5vh">
                                    <img
                                        src="https://i.imgur.com/3Ktp7tL.png"
                                        width="4%"
                                        style="margin-top: 0.3vh;"
                                        id="waitingFor2FAIcon"
                                        class="skeleton"
                                    >
                                </span>
                                Authorize login within <span id="2FACountdownText">5m 20s</span>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span style="margin-left: 0.5vh; margin-right: 0.5vh">
                                    <img
                                        src="https://i.imgur.com/3Ktp7tL.png"
                                        width="4%"
                                        style="margin-top: 0.3vh"
                                        id="retrievingFromN26Icon"
                                        class="skeleton"
                                    >
                                </span>
                                Retrieving from N26
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span style="margin-left: 0.5vh; margin-right: 0.5vh">
                                    <img
                                        src="https://i.imgur.com/3Ktp7tL.png"
                                        width="4%"
                                        style="margin-top: 0.3vh"
                                        id="insertingIntoLunchMoneyIcon"
                                        class="skeleton"
                                    >
                                </span>
                                Inserting into LunchMoney
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span style="margin-left: 0.5vh; margin-right: 0.5vh">
                                    <img
                                        src="https://i.imgur.com/3Ktp7tL.png"
                                        width="4%"
                                        style="margin-top: 0.3vh"
                                        id="savingSummaryIcon"
                                        class="skeleton"
                                    >
                                </span>
                                Saving summary
                            </td>
                        </tr>
                    </table>
                </div>
                <div style="text-align: center; margin-bottom: 0.0">
                    <p style="font-size: 1.2vh ;padding: 0; margin: 0">Recent Imports</p>
                </div>
                <div style="text-align: center; margin-bottom: 0vh">
                    <table>
                        <tr style="font-size: 0.9vh; text-align: center">
                            <td style="width: 15%">
                                
                            </td>
                            <td>
                                Retrieved
                            </td>
                            <td style="width: 60%">
                                
                            </td>
                            <td>
                                Consumed
                            </td>
                            <td style="width: 150%">
                                
                            </td>
                        </tr>
                    </table>
                </div>
                <div id="transactionBay">

                </div>
                
            </div>

            <div style=" padding-top: 0; padding-bottom: 0;">
                <div style="display: inline; padding-top: 0.7vh; margin-left: 0.9vh; text-align: right">
                    <p style="display: inline; font-size: 1.2vh ;padding: 0; margin: 0">
                        <img
                            src="https://i.imgur.com/3Ktp7tL.png"
                            width="3%"
                            style="margin-top: 0.3vh"
                            id="onlineStatusIndicator"
                        >
                        <span id="onlineStatusText" style=" font-size: 1vh; margin-bottom: 0.3vh">

                        </span>
                    </p>
                </div>
                <div style="display: inline; float: right; padding-top: 0.5vh; padding-right: 0.9vh">
                    <span>
                        <div style="display: inline; width: 40%; font-size: 1vh ; padding: 0; margin: 0">
                            Uptime: <span id="upTime"></span>
                        </div>
                    </span>
                </div>
                
                <!-- <span>
                    <div style="border: 2px solid black; width: 40%; text-align: center; margin-bottom: 0vh">
                        <p style="display: inline; font-size: 1.2vh ;padding: 0; margin: 0">
                            <img
                                src="https://i.imgur.com/3Ktp7tL.png"
                                width="5%"
                                id="onlineStatusIndicator"
                            >
                            <span id="onlineStatusText">
    
                            </span>
                        </p>
                    </div>
                </span>
                <span>
                    <div style="display: inline; width: 40%; font-size: 1.2vh ; padding: 0; margin: 0">
                        Uptime: <span id="upTime"></span>
                    </div>
                </span> -->
            </div>


        </div>


        <script>
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
            ];

            checkStatus()
            setInterval(checkStatus, 10000)
            fillInRecentTransactions()

            function fillInRecentTransactions() {
                const swishLeftBorders = `border-top-right-radius: 0.9vh; border-bottom-left-radius: 0.9vh;`;
                const swishRightBorders = `border-top-left-radius: 0.9vh; border-bottom-right-radius: 0.9vh;`;
                const borderArr = [
                    "border-top-right-radius: 0.9vh;", 
                    "border-bottom-right-radius: 0.9vh;",
                    "border-top-left-radius: 0.9vh;",
                    "border-bottom-left-radius: 0.9vh;",
                ]
                let outputHTML = "";
                const transactions = [
                    {
                        "n26FoundTransactions": 4,
                        "lunchMoneyInseredTransactions": 3,
                        "daysLookedUp": 2,
                        "currTime": 1663182596930
                    },
                    {
                        "n26FoundTransactions": 12,
                        "lunchMoneyInseredTransactions": 9,
                        "daysLookedUp": 9,
                        "currTime": 1663182596930
                    }]

                    const fiveOrLessMostRecentTransactions = transactions.length >= 4 ? transactions.slice(3) : transactions;
                for (let i = 0; i < fiveOrLessMostRecentTransactions.length; i++) {
                    const curr = transactions[i];
                    const transactionDate = new Date(curr.currTime);
                    let dateAtBeginningOfScan = new Date(curr.currTime);
                    dateAtBeginningOfScan = new Date(dateAtBeginningOfScan.setDate(dateAtBeginningOfScan.getDate() - curr.daysLookedUp))

                    let borderRadiuses = "";
                    for (let k = 0; k < 4; k++) {
                        const randNum = Math.floor(Math.random() * 2)
                        if (randNum % 2 == 0) {
                            borderRadiuses += borderArr[k]
                        }
                    } 
                    const bottomMargin = i == (fiveOrLessMostRecentTransactions.length - 1) ? '' : 'margin-bottom: 0.8vh;';

                    outputHTML += `
                    <td>
                    </td>
                    <div style="${bottomMargin} padding: 0.2vh 0.5vh 0.2vh 0.5vh; border: 1px solid grey; ${borderRadiuses}">
                        <table>
                            <tr style="text-align: center; width: 100%; float: center">

                                <td style="width: 3vh">
                                    <img
                                        src="https://i.imgur.com/vNnbGKp.png"
                                        width="100%"
                                        style="filter: invert()"
                                    >   
                                </td>

                                <td>
                                </td>

                                <td style="font-weight: bold; width: 20%; margin-left: 0.4vh; text-align: left">
                                    ${curr.n26FoundTransactions}
                                </td>

                                <td style="width: 20%">
                                </td>

                                <td style="font-weight: bold; width: 20%; text-align: right ">
                                    ${curr.lunchMoneyInseredTransactions}
                                </td>

                                <td>
                                </td>

                                <td style="width: 90%;float: right">
                                    <img
                                        src="https://i.imgur.com/aD0grat.png"
                                        width="60%"
                                    >
                                </td>

                            </tr>
                        </table>
                        <div style="text-align: center">
                            <div style="display: inline; font-size: 1.1vh">
                                ${getDaysApartOutputString(dateAtBeginningOfScan, transactionDate)}
                            </div>
                        </div>
                    </div>
                    `
                }

                document.getElementById("transactionBay").innerHTML = outputHTML;
            }

            document.getElementById("importTransactionsButton").addEventListener("click", function(e){
                e.preventDefault();

                const ws = new WebSocket("ws://localhost:2944/ws/transactions?days=12");
                ws.onopen = function(e) {
                    console.log("[open] Connection established");
                    console.log("Sending to server");
                };

                ws.onmessage = function(event) {
                    handleNewWsMessage(event)
                }

                ws.onclose = function(event) {
                    if (event.wasClean) {
                        console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
                    } else {
                        // e.g. server process killed or network down
                        // event.code is usually 1006 in this case
                        console.log('[close] Connection died');
                    }
                };
            });

            function handleNewWsMessage(event) {
                const res = JSON.parse(event.data)
                console.log(res)

                // This is not best practice teehee
                if (res.msg == "N26 has been authorized") {
                    document.getElementById("waitingFor2FAIcon").classList.remove("skeleton");
                }
                else if (res.msg == "Retrieved transactions from N26") {
                    document.getElementById("retrievingFromN26Icon").classList.remove("skeleton");
                }
                else if (res.msg == "transactions inserted into LunchMoney") {
                    document.getElementById("insertingIntoLunchMoneyIcon").classList.remove("skeleton");
                }
                else if (res.msg == "transaction finished") {
                    document.getElementById("savingSummaryIcon").classList.remove("skeleton");
                }
            }

            function getDaysApartOutputString(first, second) {
                if (first.getMonth() == second.getMonth()) {
                    return `${first.getDate()} - ${second.getDate()} ${monthNames[first.getMonth()]}`
                } else {
                    return `${first.getDate()} ${monthNames[first.getMonth()]} - ${second.getDate()} ${monthNames[second.getMonth()]}`
                }
            }

            function dateString(date) {
                return date.getDate() + " " + monthNames[date.getMonth()]
            }

            function checkStatus() {
                fetch("http://localhost:2944/status", {
                    method: 'POST'
                })
                .then((res) => res.json())
                .then((data) => JSON.parse(data))
                .then((data) => {
                    document.getElementById("upTime").textContent = convertMsToTime(data.uptime);
                    document.getElementById("onlineStatusText").textContent = "Online"
                }, (err) => {
                    document.getElementById("upTime").textContent = "";
                    document.getElementById("onlineStatusText").textContent = "Offline"
                    document.getElementById("onlineStatusIndicator").style = "filter: invert(30)"
                });
            }

            // https://bobbyhadz.com/blog/javascript-convert-milliseconds-to-hours-minutes-seconds
            // I will not write this myself. there is no point
            function convertMsToTime(milliseconds) {
                let seconds = Math.floor(milliseconds / 1000);
                let minutes = Math.floor(seconds / 60);
                let hours = Math.floor(minutes / 60);
                let days = Math.floor(hours/24)

                seconds = seconds % 60;
                minutes = minutes % 60;
                hours = hours % 24;
                days = hours % 24

                if (days >= 1) {
                    return `${days}d`;
                }
                if (hours >= 1) {
                    return `${hours}h`;
                }
                if (minutes >= 1) {
                    return `${minutes}m`;
                }
                return `${seconds}s`;
            }

        

        </script>
    </body>
</html>