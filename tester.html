<html>
    <head>
        <title> websocket test </title>
    </head>

    <body>

        <style>
            body {
                font-family: Verdana, sans-serif
            }
        </style>

        <div style="border: 2px solid orange; width: 30vh; padding: 0.5vh">

            <div style="border: 2px solid rgb(0, 222, 181); text-align: center">
                N26 -> LunchMoney
            </div>

            <div style="border: 2px solid rgb(0, 222, 181); text-align: center; padding: 1vh">
                <div style="display: inline; border: 2px solid red; padding: 0.2vh 2vh 0.2vh 2vh; border-top-right-radius: 0.9vh; border-bottom-left-radius: 0.9vh;">
                    Import Transactions
                </div>
            </div>

            <div style="border: 2px solid rgb(0, 222, 181); text-align: center; padding: 1vh; padding-top: 0">
                <div style="border: 2px solid green; text-align: center; margin-bottom: 0.8vh">
                    <p style="font-size: 1.2vh ;padding: 0; margin: 0">Recent Imports</p>
                </div>
                <div id="transactionBay">

                </div>
                
            </div>

            <div style="border: 2px solid rgb(0, 222, 181); text-align: center; padding-top: 0; padding-bottom: 0;">
                <div style="border: 2px solid green; text-align: center; margin-bottom: 0vh">
                    <p style="font-size: 1.2vh ;padding: 0; margin: 0">Status: </p>
                </div>
                <div style="display: inline">
                    <img
                        src="https://i.imgur.com/3Ktp7tL.png"
                        width="3%"
                        id="onlineStatusIndicator"
                    >
                </div>
                <div style="display: inline">
                    <p style="font-size: 1.2vh ;padding: 0; margin: 0">Uptime: </p>
                </div>
                <div style="display: inline">
                    <p style="font-size: 1.2vh ;padding: 0; margin: 0" id="upTime"></p>
                </div>

                
            </div>

        </div>


        <script>
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
            ];

            // let ws = new WebSocket("ws://localhost:2944/ws/transactions?days=12");
            // ws.onopen = function(e) {
            //     console.log("[open] Connection established");
            //     console.log("Sending to server");
            // };

            // ws.onmessage = function(event) {
            //     console.log(`[message] Data received from server: ${event.data}`);
            // };

            // ws.onclose = function(event) {
            //     if (event.wasClean) {
            //         console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
            //     } else {
            //         // e.g. server process killed or network down
            //         // event.code is usually 1006 in this case
            //         console.log('[close] Connection died');
            //     }
            // };

            checkStatus()
            fillInRecentTransactions()

            function fillInRecentTransactions() {
                let outputHTML = "";
                const transactions = [
                    {
                        "n26FoundTransactions": 4,
                        "lunchMoneyInseredTransactions": 3,
                        "daysLookedUp": 2,
                        "currTime": 1663182596930
                    }]

                for (let i = 0; i < transactions.length; i++) {
                    const curr = transactions[i];
                    const transactionDate = new Date(curr.currTime);
                    let dateAtBeginningOfScan = new Date(curr.currTime);
                    dateAtBeginningOfScan = new Date(dateAtBeginningOfScan.setDate(dateAtBeginningOfScan.getDate() - curr.daysLookedUp))
                    // const dateString = `${date.getDate()} ${monthNames[date.getMonth()]}`

                    outputHTML += `
                    <div style="border: 2px solid red; padding: 0.2vh 2vh 0.2vh 2vh; border-top-right-radius: 0.9vh; border-bottom-left-radius: 0.9vh;">
                        <div style="display: inline; border: 2px solid black; padding-top: 0.7vh">
                            <img
                                src="https://i.imgur.com/vNnbGKp.png"
                                width="10%"
                            >
                        </div>
                        <div style="display: inline; border: 2px solid black">
                            ${curr.n26FoundTransactions}
                        </div>
                        <div style="display: inline; border: 2px solid black; padding-top: 0.7vh">
                            <img
                                src="https://i.imgur.com/aD0grat.png"
                                width="7%"
                            >
                        </div>
                        <div style="display: inline">
                            ${curr.lunchMoneyInseredTransactions}
                        </div>
                        <div>
                            <div style="display: inline; font-size: 1.1vh; border: 2px solid orange">
                                ${getDaysApartOutputString(dateAtBeginningOfScan, transactionDate)}
                            </div>
                        </div>
                    </div>
                    `
                }

                document.getElementById("transactionBay").innerHTML = outputHTML;
            }

            function getDaysApartOutputString(first, second) {
                if (first.getMonth() == second.getMonth()) {
                    return `${first.getDate()} - ${second.getDate()} ${monthNames[first.getMonth()]}`
                } else {
                    return `${first.getDate()} ${monthNames[first.getMonth()]} - ${second.getDate()} ${monthNames[second.getMonth()]}`
                }
            }

            function dateString(date) {
                console.log(date.getDate() + " " + monthNames[date.getMonth()])
                return date.getDate() + " " + monthNames[date.getMonth()]
            }

            function checkStatus() {
                fetch("http://localhost:2944/status", {
                    method: 'POST'
                })
                .then((res) => res.json())
                .then((data) => JSON.parse(data))
                .then((data) => {
                    document.getElementById("upTime").textContent = convertMsToTime(data.uptime);
                }, (err) => {
                    document.getElementById("upTime").textContent = "offline";
                    document.getElementById("onlineStatusIndicator").style = "filter: invert(30)"
                });
            }

            // function upTimeToTimeString(uptime) {
            //     let now = new Date()
            //     let startTime = new Date()
            //     startTime = new Date(startTime.setMilliseconds(startTime.getMilliseconds() - uptime))

            //     return convertMsToTime(uptime)
                
            // }

            // https://bobbyhadz.com/blog/javascript-convert-milliseconds-to-hours-minutes-seconds
            // I will not write this myself. there is no point
            function convertMsToTime(milliseconds) {
                console.log(milliseconds)
                let seconds = Math.floor(milliseconds / 1000);
                let minutes = Math.floor(seconds / 60);
                let hours = Math.floor(minutes / 60);
                let days = Math.floor(hours/24)

                seconds = seconds % 60;
                minutes = minutes % 60;

                // 👇️ If you don't want to roll hours over, e.g. 24 to 00
                // 👇️ comment (or remove) the line below
                // commenting next line gets you `24:00:00` instead of `00:00:00`
                // or `36:15:31` instead of `12:15:31`, etc.
                hours = hours % 24;
                days = hours % 24
                console.log(days, hours, minutes, seconds)
                if (days >= 1) {
                    return `${days}d ${hours}h`;
                }
                if (hours >= 1) {
                    return `${hours}h ${minutes}m`;
                }
                if (minutes >= 1) {
                    return `${minutes}m ${seconds}s`;
                }
                return `${seconds}s`;
            }

        

        </script>
    </body>
</html>